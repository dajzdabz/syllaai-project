<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyllabAI – Smart Syllabus Management Platform</title>

    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <style>
        /* Import fonts */
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary-blue: #2563eb;
            --primary-blue-dark: #1d4ed8;
            --secondary-green: #059669;
            --secondary-green-dark: #047857;
            --accent-orange: #ea580c;
            --accent-red: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --white: #ffffff;
            
            --font-mono: 'JetBrains Mono', 'Courier New', monospace;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--white);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark));
            color: var(--white);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-lg);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: var(--font-mono);
            text-decoration: none;
            color: var(--white);
            cursor: pointer;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info-header {
            display: none;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .sign-out-btn {
            background: var(--accent-red);
            color: var(--white);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .sign-out-btn:hover {
            background: #b91c1c;
        }

        /* Main Content */
        .main-content {
            padding: 2rem;
        }

        /* Sign-in Section */
        .sign-in-section {
            text-align: center;
            padding: 4rem 2rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .sign-in-section h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sign-in-section p {
            font-size: 1.125rem;
            color: var(--gray-600);
            margin-bottom: 2rem;
        }

        .google-signin-container {
            display: flex;
            justify-content: center;
            margin-top: 2rem;
        }

        .custom-google-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 500;
            display: none;
            transition: all 0.2s;
            box-shadow: var(--shadow-md);
        }

        .custom-google-btn:hover {
            background: #3367d6;
            box-shadow: var(--shadow-lg);
        }

        /* Dashboard */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .dashboard-subtitle {
            font-size: 1.125rem;
            color: var(--gray-600);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 0.875rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary {
            background: var(--primary-blue);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-blue-dark);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: var(--secondary-green);
            color: var(--white);
        }

        .btn-success:hover {
            background: var(--secondary-green-dark);
            box-shadow: var(--shadow-md);
        }

        /* Course Search Section */
        .course-search-section {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 0.75rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
        }

        .course-search-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--gray-900);
        }

        .search-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 1rem;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 500;
            color: var(--gray-700);
            font-size: 0.875rem;
        }

        .form-input {
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s;
            background: var(--white);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
        }

        .form-select {
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background: var(--white);
            transition: all 0.2s;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
        }

        /* Course Grid */
        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .course-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 0.75rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .course-card:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-blue);
            transform: translateY(-2px);
        }

        .course-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .course-code {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--primary-blue);
            font-family: var(--font-mono);
        }

        .course-semester {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            background: var(--gray-100);
            color: var(--gray-600);
            border-radius: 0.375rem;
            font-weight: 500;
        }

        .course-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .course-school {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: 1rem;
        }

        .course-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--gray-500);
            border-top: 1px solid var(--gray-100);
            padding-top: 1rem;
        }

        /* Upload Section */
        .upload-section {
            background: var(--white);
            border: 2px dashed var(--gray-300);
            border-radius: 0.75rem;
            padding: 3rem 2rem;
            text-align: center;
            margin: 2rem 0;
            transition: all 0.2s;
            display: none;
        }

        .upload-section.dragover {
            border-color: var(--primary-blue);
            background: rgb(37 99 235 / 0.05);
        }

        .upload-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gray-900);
        }

        .upload-section p {
            color: var(--gray-600);
            margin-bottom: 1.5rem;
        }

        .file-input {
            display: none;
        }

        /* Event Editor */
        .event-editor {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 0.75rem;
            padding: 2rem;
            margin: 2rem 0;
            display: none;
            box-shadow: var(--shadow-sm);
        }

        .event-editor h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--gray-900);
        }

        .events-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }

        .events-table th,
        .events-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .events-table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
        }

        .events-table td {
            font-size: 0.875rem;
        }

        .events-table input,
        .events-table select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        .events-table input:focus,
        .events-table select:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .delete-event-btn {
            background: var(--accent-red);
            color: var(--white);
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
        }

        /* Progress */
        .progress-container {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            margin: 2rem 0;
            display: none;
            box-shadow: var(--shadow-sm);
        }

        .progress-spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid var(--gray-200);
            border-top: 3px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: var(--white);
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success { background: var(--secondary-green); }
        .toast.error { background: var(--accent-red); }
        .toast.info { background: var(--primary-blue); }
        .toast.warning { background: var(--accent-orange); color: var(--white); }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: 0.75rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            margin-bottom: 2rem;
            text-align: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .modal-subtitle {
            color: var(--gray-600);
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .main-content {
                padding: 1rem;
            }

            .search-form {
                grid-template-columns: 1fr;
            }

            .courses-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray-500);
        }

        .empty-state h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
        }

        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 2rem;
            color: var(--gray-500);
        }

        /* Course found result */
        .course-found {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .course-found-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <span class="logo" onclick="showDashboard()">📚 SyllabAI</span>
            <div class="user-info">
                <div class="user-info-header" id="userInfoHeader">
                    <span id="userNameHeader">Not signed in</span>
                    <button class="sign-out-btn" onclick="signOut()">Sign Out</button>
                </div>
            </div>
        </header>

        <div class="main-content">
            <!-- Sign-in Section -->
            <div class="sign-in-section" id="signInSection">
                <h1>📚 SyllabAI</h1>
                <p>Transform syllabi into smart, synchronized calendars</p>
                <div style="max-width: 500px; margin: 0 auto; font-size: 0.95rem; color: var(--gray-600);">
                    <p><strong>👨‍🏫 Professors:</strong> Upload syllabi → AI extracts events → auto-sync to student calendars</p>
                    <p><strong>🎓 Students:</strong> Join courses or upload your own syllabus → sync to Google Calendar</p>
                </div>
                <div class="google-signin-container">
                    <div id="googleSignInBtn"></div>
                    <button class="custom-google-btn" id="customGoogleBtn" onclick="handleCustomSignIn()">
                        🔐 Sign in with Google
                    </button>
                </div>
            </div>

            <!-- Professor Dashboard -->
            <div class="dashboard" id="professorDashboard">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Professor Dashboard</h1>
                    <p class="dashboard-subtitle">Manage courses and sync syllabi to student calendars</p>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showCreateCourseModal()">
                        ➕ Create New Course
                    </button>
                    <button class="btn btn-secondary" onclick="loadMyCourses()">
                        🔄 Refresh Courses
                    </button>
                </div>
                
                <div id="professorCourses" class="courses-grid">
                    <div class="loading-state">
                        <div class="progress-spinner"></div>
                        <p>Loading courses...</p>
                    </div>
                </div>
            </div>

            <!-- Student Dashboard -->
            <div class="dashboard" id="studentDashboard">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Student Dashboard</h1>
                    <p class="dashboard-subtitle">Join courses and sync events to your calendar</p>
                </div>
                
                <!-- Course Search -->
                <div class="course-search-section">
                    <h3>🔍 Find Your Course</h3>
                    <div class="search-form">
                        <div class="form-group">
                            <label for="schoolSelect">School</label>
                            <select id="schoolSelect" class="form-select">
                                <option value="">Select School...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="crnInput">Course CRN</label>
                            <input type="text" id="crnInput" class="form-input" placeholder="e.g., 12345" maxlength="10">
                        </div>
                        <div class="form-group">
                            <label for="semesterSelect">Semester</label>
                            <select id="semesterSelect" class="form-select">
                                <option value="">Select Semester...</option>
                                <option value="2025SP">Spring 2025</option>
                                <option value="2025SU">Summer 2025</option>
                                <option value="2025FA">Fall 2025</option>
                                <option value="2026SP">Spring 2026</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="searchCourse()">Search</button>
                    </div>
                    
                    <div id="courseSearchResult"></div>
                </div>

                <!-- Student's Enrolled Courses -->
                <div id="studentCourses" class="courses-grid">
                    <div class="loading-state">
                        <div class="progress-spinner"></div>
                        <p>Loading enrolled courses...</p>
                    </div>
                </div>

                <!-- Self-Upload Section -->
                <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--gray-200);">
                    <h3 style="text-align: center; margin-bottom: 1rem; color: var(--gray-700);">📄 Or Upload Your Own Syllabus</h3>
                    <div class="upload-section" id="selfUploadSection" style="display: block;">
                        <h3>Drag & Drop Your Syllabus</h3>
                        <p>Upload a PDF or Word document and we'll extract events for you</p>
                        <input type="file" id="selfFileInput" class="file-input" accept=".pdf,.docx">
                        <button class="btn btn-secondary" onclick="document.getElementById('selfFileInput').click()">
                            📎 Choose File
                        </button>
                    </div>
                </div>
            </div>

            <!-- Syllabus Upload Section (Professor) -->
            <div class="upload-section" id="professorUploadSection">
                <h3>Upload Syllabus for <span id="selectedCourseName">Selected Course</span></h3>
                <p>Drop your syllabus here or click to browse • Supports PDF and Word documents</p>
                <input type="file" id="professorFileInput" class="file-input" accept=".pdf,.docx">
                <button class="btn btn-secondary" onclick="document.getElementById('professorFileInput').click()">
                    📎 Choose File
                </button>
            </div>

            <!-- Event Editor -->
            <div class="event-editor" id="eventEditor">
                <h3>📅 Review and Edit Events</h3>
                <p style="color: var(--gray-600); margin-bottom: 1.5rem;">
                    AI has extracted these events from your syllabus. Review and edit as needed, then publish to sync with student calendars.
                </p>
                
                <div style="overflow-x: auto;">
                    <table class="events-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Category</th>
                                <th>Location</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="eventsTableBody">
                            <!-- Events will be populated here -->
                        </tbody>
                    </table>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="hideEventEditor()">Cancel</button>
                    <button class="btn btn-success" onclick="publishEvents()">
                        🚀 Publish Events
                    </button>
                </div>
            </div>

            <!-- Progress Container -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-spinner"></div>
                <h3 id="progressStatus">Processing...</h3>
                <p id="progressSubstatus" style="color: var(--gray-600);">Please wait while we analyze your syllabus</p>
            </div>
        </div>

        <!-- Create Course Modal -->
        <div class="modal-overlay" id="createCourseModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Create New Course</h2>
                    <p class="modal-subtitle">Enter the course details below</p>
                </div>
                <form id="createCourseForm" onsubmit="handleCreateCourse(event)">
                    <div class="form-group">
                        <label for="courseSchool">School</label>
                        <select id="courseSchool" class="form-select" required>
                            <option value="">Select School...</option>
                        </select>
                        <input type="text" id="newSchoolName" class="form-input" placeholder="Or enter new school name" style="margin-top: 0.5rem;">
                    </div>
                    <div class="form-group">
                        <label for="courseCRN">Course CRN</label>
                        <input type="text" id="courseCRN" class="form-input" required maxlength="10" 
                               placeholder="e.g., 12345">
                    </div>
                    <div class="form-group">
                        <label for="courseTitle">Course Title</label>
                        <input type="text" id="courseTitle" class="form-input" required maxlength="100" 
                               placeholder="e.g., Introduction to Psychology">
                    </div>
                    <div class="form-group">
                        <label for="courseSemester">Semester</label>
                        <select id="courseSemester" class="form-select" required>
                            <option value="">Select Semester...</option>
                            <option value="2025SP">Spring 2025</option>
                            <option value="2025SU">Summer 2025</option>
                            <option value="2025FA">Fall 2025</option>
                            <option value="2026SP">Spring 2026</option>
                        </select>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeCreateCourseModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Course</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ====================================================================
        // CONFIGURATION & GLOBAL STATE
        // ====================================================================
        
        const API_BASE_URL = 'https://syllaai-ai.onrender.com';  // Update this!
        
        let currentUser = null;
        let authToken = null;
        let selectedCourse = null;
        let extractedEvents = [];
        let schools = [];
        
        const GOOGLE_CLIENT_ID = '208074157418-pr4ks1ronvggb2blrqoomd8hhutkmco1.apps.googleusercontent.com';
        const SCOPES = 'openid email profile https://www.googleapis.com/auth/calendar';

        // ====================================================================
        // INITIALIZATION
        // ====================================================================

        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        async function initializeApp() {
            console.log('🚀 Initializing SyllabAI MVP...');
            
            try {
                setupFileUpload();
                await initializeGoogleAuth();
                await loadSchools();
                showSignInSection();
                console.log('✅ App initialized');
            } catch (error) {
                console.error('❌ App initialization failed:', error);
                showToast('App initialization failed. Please refresh the page.', 'error');
            }
        }

        // ====================================================================
        // GOOGLE AUTHENTICATION
        // ====================================================================

        async function initializeGoogleAuth() {
            try {
                await waitForGoogle();
                
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: handleCredentialResponse,
                    auto_select: false
                });

                try {
                    google.accounts.id.renderButton(
                        document.getElementById('googleSignInBtn'),
                        { theme: 'outline', size: 'large', text: 'signin_with', width: 300 }
                    );
                } catch (error) {
                    document.getElementById('customGoogleBtn').style.display = 'block';
                }

                console.log('✅ Google Auth initialized');
            } catch (error) {
                console.error('❌ Google Auth failed:', error);
                document.getElementById('customGoogleBtn').style.display = 'block';
            }
        }

        async function waitForGoogle() {
            let attempts = 0;
            while (attempts < 50) {
                if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
                    return;
                }
                await sleep(100);
                attempts++;
            }
            throw new Error('Google API failed to load');
        }

        function handleCustomSignIn() {
            if (google && google.accounts && google.accounts.id) {
                google.accounts.id.prompt();
            } else {
                showToast('Google authentication is not available. Please refresh the page.', 'error');
            }
        }

        async function handleCredentialResponse(response) {
            try {
                console.log('🔐 Received Google credential');
                await signInWithBackend(response.credential);
            } catch (error) {
                console.error('❌ Authentication failed:', error);
                showToast(`Authentication failed: ${error.message}`, 'error');
            }
        }
        
        // Add error handling for browser extension conflicts
        window.addEventListener('error', function(event) {
            // Ignore chrome extension errors
            if (event.filename && event.filename.includes('chrome-extension://')) {
                event.preventDefault();
                return;
            }
            // Ignore Google Auth CORS errors
            if (event.message && event.message.includes('Cross-Origin-Opener-Policy')) {
                event.preventDefault();
                return;
            }
        });
        
        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            // Ignore chrome extension promise rejections
            if (event.reason && event.reason.message && (
                event.reason.message.includes('message port closed') ||
                event.reason.message.includes('message channel closed') ||
                event.reason.message.includes('Cross-Origin-Opener-Policy')
            )) {
                event.preventDefault();
                return;
            }
        });

        async function signInWithBackend(googleToken) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/google`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: googleToken })
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ detail: 'Authentication failed' }));
                    throw new Error(error.detail);
                }
                
                const authResult = await response.json();
                authToken = authResult.access_token;
                currentUser = authResult.user;
                
                showToast('✅ Signed in successfully!', 'success');
                updateUIForSignedInUser();
                
            } catch (error) {
                console.error('❌ Backend authentication failed:', error);
                throw error;
            }
        }

        function signOut() {
            authToken = null;
            currentUser = null;
            selectedCourse = null;
            extractedEvents = [];
            
            showSignInSection();
            showToast('Signed out successfully', 'info');
        }

        // ====================================================================
        // UI MANAGEMENT
        // ====================================================================

        function updateUIForSignedInUser() {
            document.getElementById('signInSection').style.display = 'none';
            
            const userInfoHeader = document.getElementById('userInfoHeader');
            const userNameHeader = document.getElementById('userNameHeader');
            
            if (currentUser) {
                userNameHeader.textContent = `${currentUser.name} (${currentUser.role})`;
                userInfoHeader.style.display = 'flex';
                
                if (currentUser.role === 'professor') {
                    showProfessorDashboard();
                } else {
                    showStudentDashboard();
                }
            }
        }

        function showSignInSection() {
            document.getElementById('signInSection').style.display = 'block';
            document.getElementById('professorDashboard').classList.remove('active');
            document.getElementById('studentDashboard').classList.remove('active');
            document.getElementById('userInfoHeader').style.display = 'none';
        }

        function showProfessorDashboard() {
            document.getElementById('professorDashboard').classList.add('active');
            document.getElementById('studentDashboard').classList.remove('active');
            loadMyCourses();
        }

        function showStudentDashboard() {
            document.getElementById('studentDashboard').classList.add('active');
            document.getElementById('professorDashboard').classList.remove('active');
            loadMyCourses();
            loadSchoolsForSearch();
        }

        function showDashboard() {
            if (currentUser) {
                if (currentUser.role === 'professor') {
                    showProfessorDashboard();
                } else {
                    showStudentDashboard();
                }
            }
        }

        // ====================================================================
        // SCHOOL MANAGEMENT
        // ====================================================================

        async function loadSchools() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/courses/schools`);
                if (response.ok) {
                    schools = await response.json();
                }
            } catch (error) {
                console.warn('Failed to load schools:', error);
                schools = [
                    { id: 1, name: 'University of Michigan' },
                    { id: 2, name: 'Michigan State University' },
                    { id: 3, name: 'Wayne State University' }
                ];
            }
        }

        function loadSchoolsForSearch() {
            const schoolSelect = document.getElementById('schoolSelect');
            const courseSchoolSelect = document.getElementById('courseSchool');
            
            schoolSelect.innerHTML = '<option value="">Select School...</option>';
            courseSchoolSelect.innerHTML = '<option value="">Select School...</option>';
            
            schools.forEach(school => {
                const option1 = new Option(school.name, school.id);
                const option2 = new Option(school.name, school.id);
                schoolSelect.add(option1);
                courseSchoolSelect.add(option2);
            });
        }

        // ====================================================================
        // COURSE MANAGEMENT
        // ====================================================================

        async function loadMyCourses() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/courses/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to load courses');
                
                const courses = await response.json();
                displayCourses(courses);
                
            } catch (error) {
                console.error('❌ Failed to load courses:', error);
                showToast('Failed to load courses', 'error');
                
                // Show empty state
                const container = currentUser.role === 'professor' 
                    ? document.getElementById('professorCourses')
                    : document.getElementById('studentCourses');
                
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No courses found</h3>
                        <p>${currentUser.role === 'professor' ? 'Create your first course to get started!' : 'Search for courses to join above!'}</p>
                    </div>
                `;
            }
        }

        function displayCourses(courses) {
            const container = currentUser.role === 'professor' 
                ? document.getElementById('professorCourses')
                : document.getElementById('studentCourses');
            
            if (courses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No courses found</h3>
                        <p>${currentUser.role === 'professor' ? 'Create your first course to get started!' : 'Search for courses to join above!'}</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = courses.map(course => {
                const schoolName = course.school ? course.school.name : 'Unknown School';
                const studentCount = course.student_count || 0;
                
                return `
                    <div class="course-card" onclick="selectCourse('${course.id}', '${course.title}', '${course.crn}')">
                        <div class="course-header">
                            <div class="course-code">${course.crn}</div>
                            <div class="course-semester">${course.semester}</div>
                        </div>
                        <div class="course-title">${course.title}</div>
                        <div class="course-school">${schoolName}</div>
                        <div class="course-meta">
                            <span>Created: ${new Date(course.created_at).toLocaleDateString()}</span>
                            ${currentUser.role === 'professor' 
                                ? `<span>${studentCount} students</span>` 
                                : '<span>Click to view</span>'
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectCourse(courseId, courseTitle, courseCrn) {
            selectedCourse = { id: courseId, title: courseTitle, crn: courseCrn };
            
            if (currentUser.role === 'professor') {
                document.getElementById('selectedCourseName').textContent = `${courseTitle} (${courseCrn})`;
                document.getElementById('professorUploadSection').style.display = 'block';
                showToast(`Course selected: ${courseTitle}. Upload a syllabus to get started.`, 'success');
            } else {
                showToast(`Selected course: ${courseTitle} (${courseCrn})`, 'info');
            }
        }

        // ====================================================================
        // COURSE CREATION
        // ====================================================================

        function showCreateCourseModal() {
            loadSchoolsForSearch();
            document.getElementById('createCourseModal').classList.add('show');
        }

        function closeCreateCourseModal() {
            document.getElementById('createCourseModal').classList.remove('show');
            document.getElementById('createCourseForm').reset();
        }

        async function handleCreateCourse(event) {
            event.preventDefault();
            
            const schoolId = document.getElementById('courseSchool').value;
            const newSchoolName = document.getElementById('newSchoolName').value.trim();
            const crn = document.getElementById('courseCRN').value.trim();
            const title = document.getElementById('courseTitle').value.trim();
            const semester = document.getElementById('courseSemester').value;
            
            if (!title || !crn || !semester) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            try {
                let finalSchoolId = schoolId;
                
                // Create new school if needed
                if (!schoolId && newSchoolName) {
                    const schoolResponse = await fetch(`${API_BASE_URL}/api/courses/schools`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name: newSchoolName })
                    });
                    
                    if (schoolResponse.ok) {
                        const newSchool = await schoolResponse.json();
                        finalSchoolId = newSchool.id;
                    }
                }
                
                if (!finalSchoolId) {
                    showToast('Please select a school or enter a new school name', 'error');
                    return;
                }
                
                // Create course
                const response = await fetch(`${API_BASE_URL}/api/courses/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        school_id: parseInt(finalSchoolId),
                        crn: crn,
                        title: title,
                        semester: semester
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to create course');
                }
                
                const course = await response.json();
                showToast(`Course created! CRN: ${course.crn}`, 'success');
                closeCreateCourseModal();
                loadMyCourses();
                
            } catch (error) {
                console.error('❌ Course creation failed:', error);
                showToast(`Failed to create course: ${error.message}`, 'error');
            }
        }

        // ====================================================================
        // COURSE SEARCH (Students)
        // ====================================================================

        async function searchCourse() {
            const schoolId = document.getElementById('schoolSelect').value;
            const crn = document.getElementById('crnInput').value.trim();
            const semester = document.getElementById('semesterSelect').value;
            
            if (!schoolId || !crn || !semester) {
                showToast('Please fill in all search fields', 'warning');
                return;
            }
            
            try {
                const response = await fetch(
                    `${API_BASE_URL}/api/courses/search?school_id=${schoolId}&crn=${crn}&semester=${semester}`
                );
                
                const course = await response.json();
                displaySearchResult(course);
                
            } catch (error) {
                console.error('❌ Course search failed:', error);
                showToast('Course search failed', 'error');
            }
        }

        function displaySearchResult(course) {
            const resultContainer = document.getElementById('courseSearchResult');
            
            if (!course) {
                resultContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--gray-500);">
                        <h3>Course not found</h3>
                        <p>No course found with those details. Check with your professor.</p>
                    </div>
                `;
                return;
            }
            
            const schoolName = course.school ? course.school.name : 'Unknown School';
            const studentCount = course.student_count || 0;
            
            resultContainer.innerHTML = `
                <div class="course-found">
                    <div class="course-found-header">
                        <div>
                            <div class="course-code">${course.crn}</div>
                            <div class="course-title">${course.title}</div>
                            <div class="course-school">${schoolName} • ${course.semester}</div>
                        </div>
                        <button class="btn btn-success" onclick="enrollInCourse('${course.id}')">
                            📚 Enroll
                        </button>
                    </div>
                    <p style="color: var(--gray-600); font-size: 0.875rem;">
                        ${studentCount} students enrolled
                    </p>
                </div>
            `;
        }

        async function enrollInCourse(courseId) {
            try {
                const schoolId = document.getElementById('schoolSelect').value;
                const crn = document.getElementById('crnInput').value.trim();
                const semester = document.getElementById('semesterSelect').value;
                
                const response = await fetch(`${API_BASE_URL}/api/courses/join`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        school_id: parseInt(schoolId),
                        crn: crn,
                        semester: semester
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to enroll');
                }
                
                showToast('Successfully enrolled in course!', 'success');
                loadMyCourses();
                document.getElementById('courseSearchResult').innerHTML = '';
                
                // Clear form
                document.getElementById('schoolSelect').value = '';
                document.getElementById('crnInput').value = '';
                document.getElementById('semesterSelect').value = '';
                
            } catch (error) {
                console.error('❌ Enrollment failed:', error);
                showToast(`Enrollment failed: ${error.message}`, 'error');
            }
        }

        // ====================================================================
        // FILE UPLOAD & PROCESSING
        // ====================================================================

        function setupFileUpload() {
            // Professor upload
            const professorUpload = document.getElementById('professorUploadSection');
            const professorFileInput = document.getElementById('professorFileInput');
            
            professorUpload.addEventListener('dragover', handleDragOver);
            professorUpload.addEventListener('dragleave', handleDragLeave);
            professorUpload.addEventListener('drop', (e) => handleDrop(e, 'professor'));
            
            professorFileInput.addEventListener('change', (e) => {
                if (e.target.files.length) handleFileSelect(e.target.files[0], 'professor');
            });
            
            // Student self-upload
            const selfUpload = document.getElementById('selfUploadSection');
            const selfFileInput = document.getElementById('selfFileInput');
            
            selfUpload.addEventListener('dragover', handleDragOver);
            selfUpload.addEventListener('dragleave', handleDragLeave);
            selfUpload.addEventListener('drop', (e) => handleDrop(e, 'student'));
            
            selfFileInput.addEventListener('change', (e) => {
                if (e.target.files.length) handleFileSelect(e.target.files[0], 'student');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e, mode) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length) handleFileSelect(files[0], mode);
        }

        async function handleFileSelect(file, mode) {
            if (!validateFile(file)) return;
            
            showProgress('Processing syllabus...', 'Extracting text and analyzing events');
            
            try {
                if (mode === 'professor') {
                    await processProfessorSyllabus(file);
                } else {
                    await processStudentSyllabus(file);
                }
            } catch (error) {
                console.error('❌ File processing failed:', error);
                showToast(`Processing failed: ${error.message}`, 'error');
            } finally {
                hideProgress();
            }
        }

        function validateFile(file) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = ['.pdf', '.docx'];
            
            if (file.size > maxSize) {
                showToast('File too large! Please use files under 10MB.', 'error');
                return false;
            }
            
            const extension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
            if (!allowedTypes.includes(extension)) {
                showToast('Invalid file type! Please upload PDF or DOCX files only.', 'error');
                return false;
            }
            
            return true;
        }

        async function processProfessorSyllabus(file) {
            if (!selectedCourse) {
                showToast('Please select a course first!', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            const response = await fetch(`${API_BASE_URL}/api/courses/${selectedCourse.id}/syllabus`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${authToken}` },
                body: formData
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to process syllabus');
            }
            
            const result = await response.json();
            extractedEvents = result.extracted_events;
            
            showToast(`Extracted ${extractedEvents.length} events from syllabus!`, 'success');
            showEventEditor();
        }

        async function processStudentSyllabus(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${API_BASE_URL}/api/courses/student-syllabus`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to process syllabus');
                }
                
                const result = await response.json();
                showToast(`Successfully extracted ${result.extracted_events.length} events from your syllabus!`, 'success');
                
                // TODO: Show events to student for review/calendar sync
                console.log('Extracted events:', result.extracted_events);
                
            } catch (error) {
                console.error('❌ Student syllabus processing failed:', error);
                showToast(`❌ Student syllabus processing failed: ${error.message}`, 'error');
            }
        }

        // ====================================================================
        // EVENT EDITOR
        // ====================================================================

        function showEventEditor() {
            const tableBody = document.getElementById('eventsTableBody');
            
            tableBody.innerHTML = extractedEvents.map((event, index) => `
                <tr>
                    <td><input type="text" value="${event.title}" onchange="updateEvent(${index}, 'title', this.value)"></td>
                    <td><input type="date" value="${event.start_ts.split('T')[0]}" onchange="updateEventDate(${index}, this.value)"></td>
                    <td><input type="time" value="${event.start_ts.split('T')[1]?.substring(0,5) || ''}" onchange="updateEventTime(${index}, this.value)"></td>
                    <td>
                        <select onchange="updateEvent(${index}, 'category', this.value)">
                            <option value="Exam" ${event.category === 'Exam' ? 'selected' : ''}>Exam</option>
                            <option value="Quiz" ${event.category === 'Quiz' ? 'selected' : ''}>Quiz</option>
                            <option value="HW" ${event.category === 'HW' ? 'selected' : ''}>Homework</option>
                            <option value="Project" ${event.category === 'Project' ? 'selected' : ''}>Project</option>
                            <option value="Presentation" ${event.category === 'Presentation' ? 'selected' : ''}>Presentation</option>
                            <option value="Class" ${event.category === 'Class' ? 'selected' : ''}>Class</option>
                            <option value="Other" ${event.category === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </td>
                    <td><input type="text" value="${event.location || ''}" onchange="updateEvent(${index}, 'location', this.value)"></td>
                    <td><button class="delete-event-btn" onclick="deleteEvent(${index})">Delete</button></td>
                </tr>
            `).join('');
            
            document.getElementById('eventEditor').style.display = 'block';
        }

        function updateEvent(index, field, value) {
            extractedEvents[index][field] = value || null;
        }

        function updateEventDate(index, dateValue) {
            const event = extractedEvents[index];
            const time = event.start_ts.split('T')[1] || '09:00:00';
            event.start_ts = `${dateValue}T${time}`;
            
            // Update end time (1 hour later)
            const startDate = new Date(event.start_ts);
            const endDate = new Date(startDate.getTime() + 60 * 60 * 1000);
            event.end_ts = endDate.toISOString();
        }

        function updateEventTime(index, timeValue) {
            const event = extractedEvents[index];
            const date = event.start_ts.split('T')[0];
            event.start_ts = `${date}T${timeValue}:00`;
            
            // Update end time (1 hour later)
            const startDate = new Date(event.start_ts);
            const endDate = new Date(startDate.getTime() + 60 * 60 * 1000);
            event.end_ts = endDate.toISOString();
        }

        function deleteEvent(index) {
            extractedEvents.splice(index, 1);
            showEventEditor(); // Refresh the table
        }

        function hideEventEditor() {
            document.getElementById('eventEditor').style.display = 'none';
            extractedEvents = [];
        }

        async function publishEvents() {
            if (!selectedCourse || extractedEvents.length === 0) {
                showToast('No events to publish', 'error');
                return;
            }
            
            try {
                showProgress('Publishing events...', 'Creating calendar events for all students');
                
                const response = await fetch(`${API_BASE_URL}/api/courses/${selectedCourse.id}/events/publish`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(extractedEvents)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to publish events');
                }
                
                const result = await response.json();
                showToast(`Successfully published ${result.events_created} events!`, 'success');
                hideEventEditor();
                
            } catch (error) {
                console.error('❌ Event publishing failed:', error);
                showToast(`Publishing failed: ${error.message}`, 'error');
            } finally {
                hideProgress();
            }
        }

        // ====================================================================
        // PROGRESS & UI HELPERS
        // ====================================================================

        function showProgress(status, substatus) {
            document.getElementById('progressStatus').textContent = status;
            document.getElementById('progressSubstatus').textContent = substatus;
            document.getElementById('progressContainer').style.display = 'block';
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        function showToast(message, type = 'info') {
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ====================================================================
        // EVENT LISTENERS
        // ====================================================================

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeCreateCourseModal();
            }
        });

        document.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal-overlay')) {
                closeCreateCourseModal();
            }
        });

        // Enter key for course search
        document.getElementById('crnInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchCourse();
        });
    </script>
</body>
</html><!DOCTYPE html>
